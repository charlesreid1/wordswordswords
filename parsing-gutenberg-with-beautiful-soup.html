<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Parsing Gutenberg with Beautiful Soup &mdash; Words Words Words</title>
    <meta name="author" content="charlesreid1">



    <!-- http://t.co/dKP3o1e -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1">


      <link href="/wordswordswords/favicon.png" rel="icon">



    <!--
    my CSS styles
    -->
    <link href="/wordswordswords/theme/css/bootstrap.css"        rel="stylesheet" type="text/css">
    <link href="/wordswordswords/theme/css/darkly.css"           rel="stylesheet" type="text/css"/>
    <link href="/wordswordswords/theme/css/navbar.css"           rel="stylesheet" type="text/css"/>
    <link href="/wordswordswords/theme/css/wordswordswords.css"  rel="stylesheet" type="text/css"/>
    <link href="/wordswordswords/theme/css/pygment.css"          rel="stylesheet" type="text/css"/>
    <link href="/wordswordswords/theme/css/main.css"             rel="stylesheet" type="text/css"/>


    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

    <link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic"
          rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic"
          rel="stylesheet" type="text/css"/>
</head>

<body>

<!-- Fixed navbar -->
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
        <div class="navbar navbar-nav navbar-right">
            <a class="navbar-brand" href="index.html">words words words</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">

                <li>
                    <a href="/wordswordswords/index.html">Home</a>
                </li>

                <li>
                    <a href="/wordswordswords/books.html">Books</a>
                </li>

                <li>
                    <a href="/wordswordswords/code.html">Code</a>
                </li>

                <li>
                    <a href="/wordswordswords/blog.html">Blog</a>
                </li>

                <li>
                    <a href="/wordswordswords/author.html">Author</a>
                </li>

            </ul>
        </div>
    </div>
</nav>


<div class="container">

<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">Parsing Gutenberg with Beautiful Soup</h1>
    <p class="meta">
<time datetime="2015-01-31T18:00:00-08:00" pubdate>Sat 31 January 2015</time>    </p>
</header>

  <div class="entry-content"><p>The starting point for the Words Words Words (WWW) project 
was the book - the original goal was to tag the etymology
of each word of an entire book. Gutenberg was a natural choice
for a starting point. </p>
<p>In my procedure, I was parsing each Gutenberg book
using a two-pass strategy.</p>
<p>In the first pass of the book, I extracted all text 
from the file, and assembled wordcounts using the 
TextBlob library. This gives me a list of unique words
appearing in that book. </p>
<p>This list was then used to look up the etymology of each word
on the Online Etymology Dictionary.</p>
<p>In the second pass of the book, I was adding formatting tags
to each word, based on its root language. I was then saving that
modified HTML document to a new file, which I could then 
put on the WWW project website.</p>
<h2>Pass 1: Extracting Text from a Gutenberg Book</h2>
<p>The process of extracting all text from a Gutenberg book
involves using BeautifulSoup to locate all paragraph tags,
extract the text from these paragraph tags, and count the 
words of the resulting string.</p>
<p>Here is some code to do that, without counting words in the
table of contents:</p>
<div class="highlight"><pre><span class="c"># ------</span>
<span class="c"># page text</span>
<span class="c"># &lt;p&gt;</span>
<span class="c"># the texttags contain the text</span>
<span class="k">print</span> <span class="s">&quot;Turning HTML into text...&quot;</span>
<span class="n">texttags_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">&#39;p&#39;</span><span class="p">,</span><span class="n">text</span><span class="o">=</span><span class="bp">True</span><span class="p">)]</span>
<span class="n">texttags</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">tta</span> <span class="ow">in</span> <span class="n">texttags_all</span><span class="p">:</span>
    <span class="k">if</span> <span class="s">&#39;class&#39;</span> <span class="ow">in</span> <span class="n">tt</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">tt</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">&#39;class&#39;</span><span class="p">]</span><span class="o">==</span><span class="s">&#39;toc&#39;</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="n">texttags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tta</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;len(texttags) =&quot;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">texttags</span><span class="p">)</span>

<span class="n">all_text</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">texttags</span><span class="p">:</span>
    <span class="n">all_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
</pre></div>


<p>Now the variable <code>all_text</code> is a list of strings, 
one list element for each paragraph of the text. 
We can join each of these together into a single string,
and create a TextBlob object from that large string.</p>
<div class="highlight"><pre><span class="n">s</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_text</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">TextBlob</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;done&quot;</span>
</pre></div>


<p>TextBlob is a text processing library that will give us 
access to some convenient functionality.</p>
<p>Now that list of words can be put in a data container 
(I am using a Pandas DataFrame):</p>
<div class="highlight"><pre><span class="k">print</span> <span class="s">&quot;Getting word counts...&quot;</span>
<span class="n">wc</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">word_counts</span>
<span class="k">print</span> <span class="s">&quot;done&quot;</span>

<span class="n">words</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([])</span>

<span class="k">print</span> <span class="s">&quot;Populating words...&quot;</span>
<span class="k">for</span> <span class="n">the_word</span> <span class="ow">in</span> <span class="n">wc</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">the_word</span> <span class="o">=</span> <span class="n">the_word</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">d</span><span class="p">[</span><span class="s">&#39;word&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">the_word</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">d</span><span class="p">[</span><span class="s">&#39;word count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wc</span><span class="p">[</span><span class="n">the_word</span><span class="p">]</span>

    <span class="n">words</span> <span class="o">=</span> <span class="n">words</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">d</span><span class="p">])</span>

<span class="k">print</span> <span class="s">&quot;done&quot;</span>
</pre></div>


<p>Optionally, you can sort words according to their word counts:</p>
<div class="highlight"><pre><span class="k">print</span> <span class="s">&quot;Reindex according to word count ranking...&quot;</span>
<span class="n">words</span> <span class="o">=</span> <span class="n">words</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;word count&#39;</span><span class="p">,</span><span class="s">&#39;word&#39;</span><span class="p">],</span><span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="bp">False</span><span class="p">,</span><span class="bp">True</span><span class="p">])</span>
<span class="n">words</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">words</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;done&quot;</span>
</pre></div>


<p>Finally, I export the DataFrame to a CSV file. This CSV file 
then provides a convenient starting point for picking up where
this script leaves off, which we will need to do 
for our second pass of the Gutenberg document.</p>
<div class="highlight"><pre><span class="k">print</span> <span class="s">&quot;Exporting to file...&quot;</span>
<span class="n">words</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">words_csv_file</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">na_rep</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;done&quot;</span>
</pre></div>


<h2>Intermediate Step: Looking Up Word Etymology</h2>
<p>This step, which will be covered in a later post, 
involves iterating through each unique word, 
determining if the word has a root word,
removing suffixes, finding unconjugated 
forms of verbs, etc.</p>
<p>This populates elements in the list with etymology 
information, when it can be found.</p>
<h2>Pass 2: Modifying Gutenberg HTML to Add Tags</h2>
<p>Now that we have a list of each unique word in the book
and its root language, we iterate through each paragraph 
again, but this time check each word to see if 
etymology information is available for it. If so, it wraps
the word in span tags.</p>
<p>My script works one chapter at a time.</p>
<p>First, I look for all h2 tags, throwing out the first one
(which is the name of the author):</p>
<div class="highlight"><pre><span class="n">h2tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s">&#39;h2&#39;</span><span class="p">)]</span>
<span class="n">h2tags</span> <span class="o">=</span> <span class="n">h2tags</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

<span class="n">ich</span><span class="o">=</span><span class="mi">1</span>
<span class="k">for</span> <span class="n">h2tag</span> <span class="ow">in</span> <span class="n">h2tags</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;Tagging chapter heading&quot;</span><span class="p">,</span><span class="n">ich</span>

    <span class="n">h2txt</span> <span class="o">=</span> <span class="n">h2tag</span><span class="o">.</span><span class="n">string</span>

    <span class="n">new_body</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">new_body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">h2tag</span><span class="p">))</span>

    <span class="n">chapter_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ich</span><span class="p">)</span><span class="o">+</span><span class="s">&quot;.html&quot;</span>
</pre></div>


<p>We are at the chapter heading. We search for the next sibling tag,
which should either be a paragraph tag or another h2 tag for 
the next chapter heading :</p>
<div class="highlight"><pre>    <span class="n">nexttag</span> <span class="o">=</span> <span class="n">h2tag</span><span class="o">.</span><span class="n">findNextSibling</span><span class="p">([</span><span class="s">&#39;p&#39;</span><span class="p">,</span><span class="s">&#39;h2&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">nexttag</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># nothing left in the document, </span>
        <span class="c"># so exit this loop</span>
        <span class="k">break</span>

    <span class="n">ip</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">nexttag</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s">&#39;h2&#39;</span><span class="p">:</span>
            <span class="c"># we&#39;re done with all the &lt;p&gt; tags </span>
            <span class="c"># in this chapter</span>
            <span class="k">break</span>
        <span class="k">if</span> <span class="n">nexttag</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="n">ip</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">ip</span><span class="o">%</span><span class="mi">25</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Paragraph&quot;</span><span class="p">,</span><span class="n">ip</span>
</pre></div>


<p>Now we process the text in the paragraph.
The strategy is to split sentences like</p>
<div class="highlight"><pre>&quot;Tagging word etymology with python.&quot;
</pre></div>


<p>into something like:</p>
<div class="highlight"><pre>[&quot;Tagging&quot;,&quot;word&quot;,&quot;etymology&quot;,&quot;with&quot;,&quot;python&quot;]
</pre></div>


<p>If a word etymology is found, the word is wrapped in div tags,
like so:</p>
<div class="highlight"><pre>[ ..., &#39;div class=&quot;latin&quot;&gt;python&lt;/div&gt;&#39;]
</pre></div>


<p>First, split the paragraph string. </p>
<p>Iterate through each word, and search for a root language
in the word DataFrame.</p>
<p>If something is found, create the appropriate span tag.</p>
<div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="n">split</span> <span class="o">=</span> <span class="n">nexttag</span><span class="o">.</span><span class="n">string</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="c"># no text</span>
    <span class="n">split</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">if</span> <span class="n">split</span> <span class="o">&lt;&gt;</span> <span class="p">[]:</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">word_row</span> <span class="ow">in</span> <span class="n">words_w_lang</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

        <span class="n">word</span> <span class="o">=</span> <span class="n">word_row</span><span class="p">[</span><span class="s">&#39;word&#39;</span><span class="p">]</span>
        <span class="n">full_lang</span> <span class="o">=</span> <span class="n">word_row</span><span class="p">[</span><span class="s">&#39;root language&#39;</span><span class="p">]</span>
        <span class="n">lang</span> <span class="o">=</span> <span class="n">languages_key</span><span class="p">[</span><span class="n">full_lang</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">it</span><span class="p">,</span><span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">split</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">word</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="n">split</span><span class="p">[</span><span class="n">it</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;&lt;span class=&quot;&#39;</span> <span class="o">+</span> <span class="n">lang</span> <span class="o">+</span> <span class="s">&#39;&quot;&gt;&#39;</span> <span class="o">+</span> <span class="n">token</span> <span class="o">+</span> <span class="s">&#39;&lt;/span&gt;&#39;</span>

    <span class="n">new_html</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split</span><span class="p">)</span>

    <span class="n">new_body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">new_html</span> <span class="p">)</span>
</pre></div>


<p>Once we've finished, we check to see whether
there are any remaining p or h2 tags to process.</p>
<div class="highlight"><pre>    <span class="c"># increment the tag now, </span>
    <span class="c"># and do a null check </span>
    <span class="c"># (if no tag, bail out)</span>
    <span class="n">nexttag</span> <span class="o">=</span> <span class="n">nexttag</span><span class="o">.</span><span class="n">findNextSibling</span><span class="p">([</span><span class="s">&#39;p&#39;</span><span class="p">,</span><span class="s">&#39;h2&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">nexttag</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># nothing left in the document, </span>
        <span class="c"># so exit this loop</span>
        <span class="k">break</span>
</pre></div>


<p>Finally, this will bring us to the end of our Gutenberg
book. At this point, we use all of the strings we have
been assembling and appending to <code>new_body</code> to 
create a new BeautifulSoup document,</p>
<div class="highlight"><pre><span class="k">print</span> <span class="s">&quot;done with chapter&quot;</span>

<span class="k">print</span> <span class="s">&quot;Making some soup&quot;</span>
<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_body</span><span class="p">))</span>
<span class="k">print</span> <span class="s">&quot;done&quot;</span>
</pre></div>


<p>We then write that soup to the chapter HTML file,
and proceed to the next chapter:</p>
<div class="highlight"><pre><span class="k">print</span> <span class="s">&quot;Writing to file&quot;</span><span class="p">,</span><span class="n">chapter_file</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dest_dir</span><span class="o">+</span><span class="s">&quot;/&quot;</span><span class="o">+</span><span class="n">chapter_file</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">soup</span><span class="o">.</span><span class="n">prettify</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
<span class="k">print</span> <span class="s">&quot;done&quot;</span>

<span class="n">ich</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></div>


<p>All there is to it.</p></div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">
        charlesreid1
    </span>
  </span>
<time datetime="2015-01-31T18:00:00-08:00" pubdate>Sat 31 January 2015</time>  <span class="categories">
    <a class='category' href='/wordswordswords/category/.html'></a>
  </span>
</p><div class="sharing">
</div>    </footer>
  </article>

</div>

</div><!--container-->

</body>
</html>

